---
ID: "8db11279-bb79-4440-a248-4879badfa484"
Parent: "2b339081-5fa3-4b4a-a497-001d727a3c7d"
Template: "dd22f1b3-bd87-4db2-9e7d-f7a496888d43"
Path: "/sitecore/system/Modules/PowerShell/Script Library/X-Demo/Development/Create Module Cache"
DB: master
SharedFields:
- ID: "b1a94ff0-6897-47c0-9c51-aa6acb80b1f0"
  Hint: Script
  Value: |
    $VerbosePreference = "Continue"
    
    Write-Verbose "Requesting the list of available modules."
    $searchResponse = Invoke-RestMethod -Uri "https://marketplace.sitecore.net/Services/Modules.svc/Search" -Method Post -ContentType "application/json;charset=UTF-8" -Body '{"query":"", "offset":"0", "count":"1000", "category":"", "requirement":"", "familyIds":[], "support":"" }'
    $modules = $searchResponse.more.items | Where-Object { $_.ModuleName } | Select-Object -Property ModuleName, Description, Link, Like | Sort-Object -Property Like -Descending
    
    $moduleIdpattern = @"
    (<input type="hidden" id="hfModuleId" value='(?<moduleId>[{(]?[0-9A-F]{8}[-]?([0-9A-F]{4}[-]?){3}[0-9A-F]{12}[)}]?))
    "@
    
    function Get-PageContent {
        param(
            [string]$Link
        )
    
        [System.Net.HttpWebRequest]$r = [System.Net.WebRequest]::Create("https://marketplace.sitecore.net" + $Link)
        [System.Net.HttpWebResponse]$resp = $r.GetResponse()
        $reqstream = $resp.GetResponseStream()
        $sr = New-Object System.IO.StreamReader $reqstream
        $sr.ReadToEnd()
    }
    
    $exportData = [ordered]@{}
    foreach($module in $modules) {
        Write-Verbose "Downloading the module page $($module.modulename)"
        $page = Get-PageContent -Link $module.link
    
        if($page) {
            Write-Verbose "Checking for guid on module page $($module.modulename)"
            if($page -match $moduleIdPattern) {
                $exportData[$module.ModuleName] = $Matches["moduleId"]
            }
        } else {
            Write-Verbose "No page content found"
        }
    }
    
    $flatData = $exportData | ConvertTo-Json
    $flatData | Out-File -FilePath "$($SitecoreDataFolder)\moduleCache.json"
    
Languages:
- Language: en
  Versions:
  - Version: 1
    Fields:
    - ID: "25bed78c-4957-4165-998a-ca1b52f67497"
      Hint: __Created
      Value: 20170106T003426Z
